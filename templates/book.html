{% extends 'base.html' %}
{% block title %}Book details!{% endblock %}

{% block body %}
<div class='bg-image-bookdetails'></div>
<div class="bookdetails">

    <h1>{{book['title']}}</h1>
    <br>
    <br>
    <div class="row">
    <div class='col-4'>
        <img class=detailsimage src="{{ book['imageLinks']['thumbnail']}}">
        <br>
        <br>
        <p id='authors'>By: {{book['authors']}}</p>
    </div>
    <p class='col-8 details'>{{book['description']}}</p>

    </div>
    <div class='row'>
    <form class='col' action="/add_book/{{google_id}}">
        <div id='add_to_collection'>
            <a>
                Add to a collection:
            </a>
            <br>
            {% set collection_count = [] %}
            {% for every in user.collections %}
                {% if book_obj in every.books%}
                    {% if collection_count.append('1') %}{% endif %}
                {% endif %}
            {% endfor %}
            {% if collection_count|length == user.collections|length %}
                <p>Book has been added to all collections</p>
            {% else %}
                <select name=collection_type>
                    {% for each in user.collections %}
                        {% if book_obj not in each.books %}
                            <option value={{each.collection_type}}>
                                {{ ' '.join(each.collection_type.split('_')).title() }}</option>
                        {% endif %}
                    {% endfor %}

                </select>
                <input type='submit' value="Add">
            {% endif %}
        </div>
    </form>

    <div class="col">
            {% for each in user.collections %}
                {% if book_obj in each.books %}
                    <p class=bookincollections> Book in these collections:</p>
                    <a href='/collection?collection={{each.id}}'>
                        {{' '.join(each.collection_type.split('_')).title() }}</a> 
                    {% for each in user.lent_books %}
                        {% if book_obj == each.book[0] and each.lent %}
                            <p>Book is currently lent from this collection to {{each.borrower.username.title()}}</p>
                            <p>Contact them at {{each.borrower.email}}</p>
                            <form action="/delete_request/{{each.id}}">
                                <input type='submit' value="Mark as returned">
                            </form>  
                        {% endif %}
                    {% endfor %}
                {% endif %}
            {% endfor %}
    </div>

    <br>
    <br>
    <div class='col'>
    {% if user.get_lender(book_obj) != [] %}
        <p>Book is already requested from {{user.get_lender(book_obj)[0].username.title()}}</p>
        <p>Contact them at {{user.get_lender(book_obj)[0].email}}</p>
        <form action="/delete_request/{{user.get_lender(book_obj)[1]}}">
            <input type='submit' value="Delete Request">
        </form>  
    {% else %}
        
        {% for friend in user.friends %}
            {% if user in friend.friends %}
                {% for each in friend.collections %}
                    {% if each.lendable %}
                        {% if book_obj in each.books%}
                            <p class='lendablefrom'>Lendable from</p>
                            <a href='/user?id={{friend.id}}'>{{friend.username}}</a>
                            <form action="/request_book/{{book_obj.google_id}}/{{each.id}}">
                                <input type='submit' value="Request to borrow">
                            </form>
                        {% endif %}
                    {% endif %}
                {% endfor %}
            {% endif %}
        {% endfor %}
    {% endif %}
    </div>
</div>
</div>
{% endblock %}