{% extends 'base.html' %}
{% block title %}User{% endblock %}

{% block body %}
    <h1>{{searched_user.username.title()}}</h1>


    {% if searched_user.id == user.id %}
        <form action='/create_collection'>
            <div>
                <label for='collection_name'>Create a new collection</label>
                <input type='text' name='collection_name' id='collection_name_other'> 
            </div>
            <div>
                <input type="checkbox" name="lendable" value="True">
                <label>Lend books from this collection</label>

                <input type="checkbox" name="private" value="True">
                <label>Make this collection private</label>
            </div>
            <input type='submit' value="Create">
        </form>
        <br>
        <div>
            <h3>Requested books</h3>
            {% for request in user.book_requests %}
                {% if not request.lent %}
                    <div>
                        {% if request.book[0].cover_img != None %}
                        <image src="{{ request.book[0].cover_img }}"></image>
                        {% endif %}
                        <a href="/book?gi={{request.book[0].google_id}}">{{request.book[0].title}}</a>
                        <p>This book has been requested from {{request.lender.username.title()}}</p>
                        <form action="/delete_request/{{request.id}}">
                            <input type='submit' value="Delete Request">
                        </form>       
                    </div>
                {% endif %}
            {% endfor %}
        </div>
        <br>
        <br>
        <div>
            <h3>Borrowed Books</h3>
            {% for request in user.book_requests %}
                {% if request.lent %}
                    <div>
                        {% if request.book[0].cover_img != None %}
                        <image src="{{ request.book[0].cover_img }}"></image>
                        {% endif %}
                        <a href="/book?gi={{request.book[0].google_id}}">{{request.book[0].title}}</a>
                        <p>This book has been lent by {{request.lender.username.title()}}</p>     
                    </div>
                {% endif %}
            {% endfor %}
        </div>
        <br>
        <br>
        <div>
            <h3>Borrow Requests from friends</h3>
            {% for request in user.lent_books %}
                {% if not request.lent %}
                    <div>
                        {% if request.book[0].cover_img != None %}
                        <image src="{{ request.book[0].cover_img }}"></image>
                        {% endif %}
                        <a href="/book?gi={{request.book[0].google_id}}">{{request.book[0].title}}</a>
                        <p>This book has been requested by {{request.borrower.username.title()}}</p>
                        <form action="/accept_request/{{request.id}}">
                            <input type='submit' value="Accept">
                        </form> 
                        <form action="/delete_request/{{request.id}}">
                            <input type='submit' value="Decline">
                        </form>      
                    </div>
                {% endif %}
            {% endfor %}
        </div>
        <br>
        <br>
        <div>
            <h3>Books Lent</h3>
            {% for request in user.lent_books %}
                {% if request.lent %}
                    <div>
                        {% if request.book[0].cover_img != None %}
                        <image src="{{ request.book[0].cover_img }}"></image>
                        {% endif %}
                        <a href="/book?gi={{request.book[0].google_id}}">{{request.book[0].title}}</a>
                        <p>This book has been borrowed by {{request.borrower.username.title()}}</p>  
                        <form action="/delete_request/{{request.id}}">
                            <input type='submit' value="Mark as returned">
                        </form>    
                    </div>
                {% endif %}
            {% endfor %}
        </div>
        <br>
        <p>Friend Requests</p>
        {% if requests == [] %}
            <p>No new Requests</p>
        {% endif %}
        {% for each in requests %}
            <a href='/user?id={{each.id}}'>{{each.username}}</a>
            <form action="/add_friend/{{each.id}}">
                <input type='submit' value="Accept Friend Request">
            </form>
            <form action="/decline_friend/{{each.id}}">
                <input type='submit' value="Decline Friend Request">
            </form>
        {% endfor %}

        <br>
        <br>

        <p>Friends</p>
        {% if user.friends == [] %}
            <p>No current friends</p>
        {% endif %}
        {% for i in range(5) %}
            {% if i < friends|length %}
                <a href='/user?id={{friends[i].id}}'>{{friends[i].username}}</a>
                {% if user in friends[i].friends %}
                    <form action="/delete_friend/{{friends[i].id}}">
                        <input type='submit' value="Delete Friend">
                    </form>
                {% else %}
                    <form action="/retract_friend_request/{{friends[i].id}}">
                        <input type='submit' value="Retract friend request">
                    </form>
                {% endif %}
            {% endif %}
        {% endfor %}
        <br>
        <a href='/friends/{{searched_user.id}}'>See all friends</a>

    {% elif searched_user in user.friends and user in searched_user.friends %}
        <p> You're friends! </p>
        <form action="/delete_friend/{{searched_user.id}}">
            <input type='submit' value="Delete Friend">
        </form>

        <br>
        <br>

        <p>Friends</p>
        {% if searched_user.friends == [] %}
            <p>No current friends</p>
        {% endif %}
        {% for i in range(5) %}
            {% if i < searched_user.friends|list|length %}
                {% if searched_user.friends[i].id != user.id%}
                    <a href='/user?id={{searched_user.friends[i].id}}'>
                        {{searched_user.friends[i].username}}</a>
                {% endif %}
            {% endif %}
        {% endfor %}
        <br>
        <a href='/friends/{{searched_user.id}}'>See all friends</a>

        
    {% elif searched_user in user.friends %}
        <p> A friend request has been sent to this user </p>

    {% elif user in searched_user.friends %}
        <form action="/add_friend/{{searched_user.id}}">
            <input type='submit' value="Accept Friend Request">
        </form>
        <form action="/decline_friend/{{searched_user.id}}">
            <input type='submit' value="Decline Friend Request">
        </form>
    
    {% else %}
        <form action="/add_friend/{{searched_user.id}}">
            <input type='submit' value="Send a Friend Request">
        </form>

    {% endif %}
    <br>
    <br>

    <h2>Collections:</h2>

    <div>
        {% for each in searched_user.collections %}
            {% if not each.private %}
                <h3>{{' '.join(each.collection_type.split('_')).title()}}</h3>
                {% for i in range(10) %}
                    {% if i < each.books|length %}
                        <div>
                            {% if each.books[i].cover_img != None %}
                            <image src="{{ each.books[i].cover_img }}"></image>
                            {% endif %}
                            <a href="/book?gi={{each.books[i].google_id}}">{{each.books[i].title}}</a>     
                        </div>
                    {% endif %}
                {% endfor %}

                <a href="/collection?collection={{each.id}}">See all books in this collection</a>
            {% endif %}
        {% endfor %}
    </div>
    {% if searched_user == user %}
        <div>
            {% for each in searched_user.collections %}
                {% if each.private %}
                    <h2 class='privatecollections'>Private Collections:</h2>
                    <h3>{{' '.join(each.collection_type.split('_')).title()}}</h3>
                    {% for i in range(10) %}
                        {% if i < each.books|length %}
                            <div>
                                {% if each.books[i].cover_img != None %}
                                <image src="{{ each.books[i].cover_img }}"></image>
                                {% endif %}
                                <a href="/book?gi={{each.books[i].google_id}}">{{each.books[i].title}}</a>     
                            </div>
                        {% endif %}
                    {% endfor %}

                    <a href="/collection?collection={{each.id}}">See all books in this collection</a>
                {% endif %}
            {% endfor %}
        </div>
    {% endif %}

{% endblock %}